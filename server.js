const Discord = require("discord.js");
const client = new Discord.Client();

/* =====================
   ãƒ€ãƒ¡ãƒ¼ã‚¸è¾æ›¸
===================== */
const damageTable = {
  "ç´ æ‰‹": "1D6-2", "ãƒ‘ãƒ³ãƒ": "1D6-2", "ã‚­ãƒƒã‚¯": "1D6-2", "é ­çªã": "1D6-2",
  "ãƒŠãƒƒã‚¯ãƒ«": "1D6", "ã‚¹ãƒ‘ã‚¤ã‚¯é´": "1D6",
  "ä½“å½“ãŸã‚Š": "1D6-2",
  "æŠ•ã’": "1D6-2", "å¼•ãå€’ã—": "1D6-2",
  "çµã‚": "1D6", "é¦–çµã‚": "1D6",
  "ãƒã‚±ãƒƒãƒˆãƒŠã‚¤ãƒ•": "1D6-2", "å°å‹ãƒŠã‚¤ãƒ•": "1D6-2", "ãƒ¡ã‚¹": "1D6-2",
  "ãƒŠã‚¤ãƒ•": "1D6",
  "è»ç”¨ãƒŠã‚¤ãƒ•": "2D6-2", "åŒ…ä¸": "2D6-2",
  "æœ¨åˆ€": "1D6",
  "ãƒ•ãƒ«ãƒ¼ãƒ¬": "2D6-2", "æ¨¡é€ åˆ€": "2D6-2", "ä»•è¾¼ã¿æ–": "2D6-2",
  "ã‚µãƒ¼ãƒ™ãƒ«": "2D6", "å°å¤ªåˆ€": "2D6",
  "æ—¥æœ¬åˆ€": "3D6-2", "è„‡å·®": "3D6-2",
  "å¤§å¤ªåˆ€": "3D6", "å¤åˆ€": "3D6", "é•·è„‡å·®": "3D6",
  "è‰åˆˆã‚ŠéŒ": "1D6+2", "å±±åˆ€": "1D6+2", "ãƒŠã‚¿": "1D6+2",
  "æ‰‹æ–§": "2D6", "å¤§ãƒŠã‚¿": "2D6",
  "æœ¨ã“ã‚Šæ–§": "3D6",
  "é‰„ãƒ‘ã‚¤ãƒ—": "2D6-2",
  "æŠ•çŸ³": "1D6",
  "å’Œå¼“": "3D6-2",
  "ã‚¢ãƒ¼ãƒã‚§ãƒªãƒ¼": "3D6-2",
  "ãƒœã‚¦ã‚¬ãƒ³": "3D6",
  "å°å£å¾„æ‹³éŠƒ": "2D6",
  "ä¸­å£å¾„æ‹³éŠƒ": "3D6",
  "å¤§å£å¾„æ‹³éŠƒ": "3D6+2",
  "å°å£å¾„ãƒ©ã‚¤ãƒ•ãƒ«": "3D6+2",
  "ä¸­å£å¾„ãƒ©ã‚¤ãƒ•ãƒ«": "4D6+2",
  "å°å£å¾„ã‚·ãƒ§ãƒƒãƒˆã‚¬ãƒ³": "3D6+2",
  "ä¸­å£å¾„ã‚·ãƒ§ãƒƒãƒˆã‚¬ãƒ³": "4D6+2"
};

/* =====================
   ç‹‚æ°—è¡¨
===================== */
const shortMadness = [
  "æ°—çµ¶ã‚ã‚‹ã„ã¯é‡‘åˆ‡ã‚Šå£°ã®ç™ºä½œ",
  "ãƒ‘ãƒ‹ãƒƒã‚¯çŠ¶æ…‹ã§é€ƒã’å‡ºã™",
  "è‚‰ä½“çš„ãªãƒ’ã‚¹ãƒ†ãƒªãƒ¼ã€ã‚ã‚‹ã„ã¯æ„Ÿæƒ…ã®å™´å‡º",
  "æ—©å£ã§æ„å‘³ä¸æ˜ã®ä¼šè©±ã€å¤šå¼ç—‡",
  "æ¥µåº¦ã®ææ€–ç—‡",
  "æ®ºäººç™–ã‚ã‚‹ã„ã¯è‡ªæ®ºç™–",
  "å¹»è¦šã‚ã‚‹ã„ã¯å¦„æƒ³",
  "åéŸ¿å‹•ä½œã‚ã‚‹ã„ã¯åéŸ¿è¨€èª",
  "ç•°æ§˜ãªã‚‚ã®ã‚’é£Ÿã¹ãŸãŒã‚‹",
  "æ˜è¿·ã‚ã‚‹ã„ã¯ç·Šå¼µç—‡"
];

const longMadness = [
  "å¥å¿˜ç—‡ã‚ã‚‹ã„ã¯æ˜è¿·/ç·Šå¼µç—‡",
  "æ¿€ã—ã„ææ€–ç—‡",
  "å¹»è¦š",
  "å¥‡å¦™ãªæ€§çš„å—œå¥½",
  "ãƒ•ã‚§ãƒ†ã‚£ãƒƒã‚·ãƒ¥",
  "åˆ¶å¾¡ä¸èƒ½ã®ãƒãƒƒã‚¯ã‚„éœ‡ãˆ",
  "å¿ƒå› æ€§è¦–è¦šéšœå®³ãƒ»é›£è´ãƒ»å››è‚¢éšœå®³",
  "çŸ­æ™‚é–“ã®å¿ƒå› åå¿œ",
  "ä¸€æ™‚çš„ååŸ·ç—‡",
  "å¼·è¿«è¦³å¿µçš„è¡Œå‹•"
];

/* =====================
   Botèµ·å‹•
===================== */
client.on("ready", () => {
  console.log("Botèµ·å‹•å®Œäº†");
  client.user.setPresence({
    game: { name: "TRPG", type: "PLAYING" }
  });
});

/* =====================
   ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç†
===================== */
client.on("message", message => {
  if (message.author.bot) return;

  const content = message.content.trim();

  /* ãƒ€ã‚¤ã‚¹è¨ˆç®— */
  if (/^[0-9dD+\-]+$/.test(content)) {
    let total = 0;
    const parts = content.replace(/-/g, "+-").split("+");

    let detail = [];

    parts.forEach(p => {
      if (p.toLowerCase().includes("d")) {
        const [c, s] = p.toLowerCase().split("d").map(Number);
        for (let i = 0; i < c; i++) {
          const r = Math.floor(Math.random() * s) + 1;
          total += r;
          detail.push(r);
        }
      } else {
        total += Number(p);
      }
    });

    message.channel.send(`ğŸ² ${content} â†’ [${detail.join(", ")}] = ${total}`);
    return;
  }

  /* æˆåŠŸåˆ¤å®š */
  if (content.startsWith("æˆåŠŸåˆ¤å®š")) {
    const target = Number(content.replace("æˆåŠŸåˆ¤å®š", "").trim());
    const roll = Math.floor(Math.random() * 100) + 1;

    let result = roll <= target ? "æˆåŠŸ" : "å¤±æ•—";
    if (result === "æˆåŠŸ" && roll <= 5) result = "ğŸ‰ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ï¼";
    if (result === "å¤±æ•—" && roll >= 95) result = "ğŸ’¥ãƒ•ã‚¡ãƒ³ãƒ–ãƒ«ï¼";

    message.channel.send(`ğŸ¯ åˆ¤å®š: ${roll} / ${target} â†’ ${result}`);
    return;
  }

  /* ãƒ€ãƒ¡ãƒ¼ã‚¸è¾æ›¸ */
  if (content.startsWith("ãƒ€ãƒ¡ãƒ¼ã‚¸")) {
    const weapon = content.replace("ãƒ€ãƒ¡ãƒ¼ã‚¸", "").trim();
    if (damageTable[weapon]) {
      message.channel.send(`${weapon} / ${damageTable[weapon]}`);
    } else {
      message.channel.send("ãã®æ­¦å™¨ã¯ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“");
    }
    return;
  }

  /* ç‹‚æ°—ãƒ€ã‚¤ã‚¹ */
  if (/ä¸€æ™‚|çŸ­æœŸ/.test(content)) {
    const r = Math.floor(Math.random() * 10);
    message.channel.send(`ğŸŒ€ ç‹‚æ°—: ${shortMadness[r]}`);
    return;
  }

  if (/é•·æœŸ|ä¸å®š/.test(content)) {
    const r = Math.floor(Math.random() * 10);
    message.channel.send(`ğŸŒ€ ç‹‚æ°—: ${longMadness[r]}`);
    return;
  }
});

/* =====================
   ãƒ­ã‚°ã‚¤ãƒ³
===================== */
client.login(process.env.DISCORD_TOKEN);

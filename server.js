const http = require("http");
const Discord = require("discord.js");
const client = new Discord.Client();

/* =========================
   Railwayç”¨ ç°¡æ˜“Webã‚µãƒ¼ãƒ
========================= */
http.createServer((req, res) => {
  res.writeHead(200, { "Content-Type": "text/plain" });
  res.end("Bot is running\n");
}).listen(process.env.PORT || 3000);

/* =========================
   èµ·å‹•æ™‚
========================= */
client.on("ready", () => {
  console.log(`ãƒ­ã‚°ã‚¤ãƒ³å®Œäº†ï¼š${client.user.tag}`);
  client.user.setPresence({
    game: { name: "TRPG", type: "PLAYING" }
  });
});

/* =========================
   ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç†
========================= */
client.on("message", message => {
  if (message.author.bot) return;

  const content = message.content.trim();

// =========================
// ğŸ—¡ ãƒ€ãƒ¡ãƒ¼ã‚¸è¡¨ï¼ˆæ‹¡å¼µç‰ˆï¼‰
// =========================
if (content.startsWith("ãƒ€ãƒ¡ãƒ¼ã‚¸")) {
  const weapon = content.replace(/^ãƒ€ãƒ¡ãƒ¼ã‚¸\s*/,"");

  const damageTable = {
    // ç´ æ‰‹ãƒ»æ ¼é—˜
    "ç´ æ‰‹": "1D6-2",
    "ãƒ‘ãƒ³ãƒ": "1D6-2",
    "ã‚­ãƒƒã‚¯": "1D6-2",
    "é ­çªã": "1D6-2",
    "ä½“å½“ãŸã‚Š": "1D6-2",
    "æŠ•ã’": "1D6-2",
    "å¼•ãå€’ã—": "1D6-2",
    "çµã‚": "1D6",
    "é¦–çµã‚": "1D6",

    // è£œåŠ©å…·
    "ãƒŠãƒƒã‚¯ãƒ«": "1D6",
    "ã‚¹ãƒ‘ã‚¤ã‚¯é´": "1D6",

    // å°å‹åˆƒç‰©
    "ãƒã‚±ãƒƒãƒˆãƒŠã‚¤ãƒ•": "1D6-2",
    "å°å‹ãƒŠã‚¤ãƒ•": "1D6-2",
    "ãƒ¡ã‚¹": "1D6-2",
    "ãƒŠã‚¤ãƒ•": "1D6",
    "è»ç”¨ãƒŠã‚¤ãƒ•": "2D6-2",
    "åŒ…ä¸": "2D6-2",

    // åˆ€å‰£é¡
    "æœ¨åˆ€": "1D6",
    "ãƒ•ãƒ«ãƒ¼ãƒ¬": "2D6-2",
    "æ¨¡é€ åˆ€": "2D6-2",
    "ä»•è¾¼ã¿æ–": "2D6-2",
    "ã‚µãƒ¼ãƒ™ãƒ«": "2D6",
    "å°å¤ªåˆ€": "2D6",
    "æ—¥æœ¬åˆ€": "3D6-2",
    "è„‡å·®": "3D6-2",
    "å¤§å¤ªåˆ€": "3D6",
    "å¤åˆ€": "3D6",
    "é•·è„‡å·®": "3D6",

    // æ–§ãƒ»éŒ
    "è‰åˆˆã‚ŠéŒ": "1D6+2",
    "å±±åˆ€": "1D6+2",
    "ãƒŠã‚¿": "1D6+2",
    "æ‰‹æ–§": "2D6",
    "å¤§ãƒŠã‚¿": "2D6",
    "æœ¨ã“ã‚Šæ–§": "3D6",

    // éˆå™¨
    "æ–": "1D6-2",
    "ã‚¹ãƒ†ãƒƒã‚­": "1D6-2",
    "è­¦æ£’": "1D6",
    "å¤§å‹ã®æœ¨æ§Œ": "1D6",
    "ãƒ–ãƒ©ãƒƒã‚¯ã‚¸ãƒ£ãƒƒã‚¯": "1D6+2",
    "æ£æ£’": "1D6+2",
    "é‡‘æ§Œ": "1D6+2",
    "é‰„æ–": "1D6+2",
    "ãƒãƒ¼ãƒ«": "2D6-2",
    "å¤§å‹ãƒãƒ³ãƒãƒ¼": "2D6-2",
    "é‡‘å±è­¦æ£’": "2D6-2",
    "ã¤ã‚‹ã¯ã—": "2D6+2",
    "ç ´å£Šæ§Œ": "2D6+2",

    // é•·æŸ„æ­¦å™¨
    "çŸ­æ§": "2D6-2",
    "éŠ›": "2D6-2",
    "éŠƒå‰£": "2D6",
    "é•·æ§": "3D6-2",
    "è–™åˆ€": "3D6-2",
    "ä¸‰åˆæ§": "3D6-2",

    // å³å¸­æ­¦å™¨
    "ãƒã‚µãƒŸ": "1D6-2",
    "ãƒ•ã‚©ãƒ¼ã‚¯": "1D6-2",
    "ã‚¢ã‚¤ã‚¹ãƒ”ãƒƒã‚¯": "1D6-2",
    "ãƒãƒŸ": "1D6-2",
    "éŒ": "1D6-2",
    "ãƒ‰ãƒ©ã‚¤ãƒãƒ¼": "1D6-2",
    "é™¶å™¨": "1D6-2",
    "ã‚¬ãƒ©ã‚¹è£½å“": "1D6-2",
    "ç“¶": "1D6-2",
    "çŸ³": "1D6",
    "ãƒ¬ãƒ³ã‚¬": "1D6",
    "æ¤æœ¨é‰¢": "1D6",
    "ãƒ•ãƒ©ã‚¤ãƒ‘ãƒ³": "1D6",
    "ã‚¢ã‚¤ãƒ­ãƒ³": "1D6",
    "ã‚·ãƒ£ãƒ™ãƒ«": "1D6",
    "ç§»æ¤ã”ã¦": "1D6",
    "è¾²å…·": "1D6",
    "ãƒ¢ãƒƒãƒ—": "1D6",
    "ãƒ‡ãƒƒã‚­ãƒ–ãƒ©ã‚·": "1D6",
    "æ¤…å­": "1D6",
    "æœº": "1D6",
    "çœ‹æ¿": "1D6",
    "é‰„é–": "1D6",
    "è§’æ": "1D6+2",
    "é‡çƒç”¨ãƒãƒƒãƒˆ": "1D6+2",
    "ã‚´ãƒ«ãƒ•ã‚¯ãƒ©ãƒ–": "1D6+2",
    "ç«ã‹ãæ£’": "1D6+2",
    "é‰„ãƒ‘ã‚¤ãƒ—": "2D6-2",

    // æŠ•æ“²ãƒ»å°„æ’ƒ
    "æŠ•çŸ³": "1D6",
    "å’Œå¼“": "3D6-2",
    "ã‚¢ãƒ¼ãƒã‚§ãƒªãƒ¼": "3D6-2",
    "ãƒœã‚¦ã‚¬ãƒ³": "3D6",
    "å°å£å¾„æ‹³éŠƒ": "2D6",
    "ä¸­å£å¾„æ‹³éŠƒ": "3D6",
    "å¤§å£å¾„æ‹³éŠƒ": "3D6+2",
    "å°å£å¾„ãƒ©ã‚¤ãƒ•ãƒ«": "3D6+2",
    "ä¸­å£å¾„ãƒ©ã‚¤ãƒ•ãƒ«": "4D6+2",
    "å°å£å¾„ã‚·ãƒ§ãƒƒãƒˆã‚¬ãƒ³": "3D6+2",
    "ä¸­å£å¾„ã‚·ãƒ§ãƒƒãƒˆã‚¬ãƒ³": "4D6+2"
  };

  if (damageTable[weapon]) {
    message.channel.send(`${weapon} / ${damageTable[weapon]}`);
  } else {
    message.channel.send("â“ ãã®æ­¦å™¨ã¯ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
  }
  return;
}

  /* =========================
     ğŸ² é€šå¸¸ãƒ€ã‚¤ã‚¹
  ========================= */
  if (/^[\ddD+\-\s]+$/.test(content) && /d/i.test(content)) {
    const result = rollDiceExpression(content);
    message.channel.send(result);
    return;
  }

  /* =========================
     ğŸ¯ æˆåŠŸåˆ¤å®š
  ========================= */
  const successMatch = content.match(/^æˆåŠŸåˆ¤å®š\s+(\d{1,3})$/);
  if (successMatch) {
    const target = parseInt(successMatch[1], 10);
    const roll = Math.floor(Math.random() * 100) + 1;

    let text = `ğŸ¯ æˆåŠŸåˆ¤å®šï¼ˆç›®æ¨™å€¤ ${target}ï¼‰\nå‡ºç›®ï¼š${roll}\n`;

    if (roll <= 5) text += "ğŸ‰ ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ï¼";
    else if (roll >= 95) text += "ğŸ’¥ ãƒ•ã‚¡ãƒ³ãƒ–ãƒ«ï¼";
    else if (roll <= target) text += "âœ… æˆåŠŸ";
    else text += "âŒ å¤±æ•—";

    message.channel.send(text);
    return;
  }

  /* =========================
     ğŸŒ€ çŸ­æœŸï¼ˆä¸€æ™‚çš„ï¼‰ç‹‚æ°—
  ========================= */
  if (/ä¸€æ™‚(çš„)?ç‹‚æ°—|çŸ­æœŸ(çš„)?ç‹‚æ°—/.test(content)) {
    const table = [
      "æ°—çµ¶ã‚ã‚‹ã„ã¯é‡‘åˆ‡ã‚Šå£°ã®ç™ºä½œ",
      "ãƒ‘ãƒ‹ãƒƒã‚¯çŠ¶æ…‹ã§é€ƒã’å‡ºã™",
      "è‚‰ä½“çš„ãƒ’ã‚¹ãƒ†ãƒªãƒ¼ã€æ„Ÿæƒ…ã®å™´å‡º",
      "æ„å‘³ä¸æ˜ãªä¼šè©±ãƒ»å¤šå¼ç—‡",
      "æ¥µåº¦ã®ææ€–ç—‡",
      "æ®ºäººç™–ã‚ã‚‹ã„ã¯è‡ªæ®ºç™–",
      "å¹»è¦šã‚ã‚‹ã„ã¯å¦„æƒ³",
      "åéŸ¿å‹•ä½œãƒ»åéŸ¿è¨€èª",
      "ç•°æ§˜ãªã‚‚ã®ã‚’é£Ÿã¹ãŸãŒã‚‹",
      "æ˜è¿·ã‚ã‚‹ã„ã¯ç·Šå¼µç—‡"
    ];
    const roll = Math.floor(Math.random() * 10);
    message.channel.send(`ğŸŒ€ ä¸€æ™‚çš„ç‹‚æ°— (${roll + 1})\n${table[roll]}`);
    return;
  }

  /* =========================
     ğŸŒ€ é•·æœŸï¼ˆä¸å®šï¼‰ç‹‚æ°—
  ========================= */
  if (/é•·æœŸ(çš„)?ç‹‚æ°—|ä¸å®š(ã®)?ç‹‚æ°—/.test(content)) {
    const table = [
      "å¥å¿˜ç—‡ã‚ã‚‹ã„ã¯æ˜è¿·/ç·Šå¼µç—‡",
      "æ¿€ã—ã„ææ€–ç—‡",
      "å¹»è¦š",
      "å¥‡å¦™ãªæ€§çš„å—œå¥½",
      "ãƒ•ã‚§ãƒ†ã‚£ãƒƒã‚·ãƒ¥",
      "åˆ¶å¾¡ä¸èƒ½ã®ãƒãƒƒã‚¯ãƒ»éœ‡ãˆ",
      "å¿ƒå› æ€§è¦–è¦šãƒ»è´è¦šéšœå®³",
      "çŸ­æ™‚é–“ã®å¿ƒå› åå¿œ",
      "ä¸€æ™‚çš„ååŸ·ç—‡",
      "å¼·è¿«è¦³å¿µè¡Œå‹•"
    ];
    const roll = Math.floor(Math.random() * 10);
    message.channel.send(`ğŸŒ€ é•·æœŸçš„ç‹‚æ°— (${roll + 1})\n${table[roll]}`);
    return;
  }
});

/* =========================
   ğŸ² ãƒ€ã‚¤ã‚¹è¨ˆç®—é–¢æ•°
========================= */
function rollDiceExpression(expr) {
  let total = 0;
  let detail = [];

  const parts = expr.replace(/\s+/g, "").split(/(?=[+-])/);

  for (let part of parts) {
    let sign = 1;
    if (part.startsWith("+")) part = part.slice(1);
    if (part.startsWith("-")) {
      sign = -1;
      part = part.slice(1);
    }

    const match = part.match(/(\d*)d(\d+)/i);
    if (match) {
      const count = parseInt(match[1] || "1", 10);
      const sides = parseInt(match[2], 10);
      let rolls = [];
      for (let i = 0; i < count; i++) {
        const r = Math.floor(Math.random() * sides) + 1;
        rolls.push(r);
        total += r * sign;
      }
      detail.push(`${sign < 0 ? "-" : ""}${count}D${sides}[${rolls.join(",")}]`);
    } else {
      total += parseInt(part, 10) * sign;
    }
  }

  return `ğŸ² ${expr}\n${detail.join(" ")}\nåˆè¨ˆï¼š${total}`;
}

/* =========================
   ãƒ­ã‚°ã‚¤ãƒ³
========================= */
client.login(process.env.DISCORD_TOKEN);

// =========================
// server.js - TRPG Discord Bot (v14å¯¾å¿œç‰ˆ)
// =========================

const { Client, GatewayIntentBits } = require("discord.js");

// â˜… Clientä½œæˆæ™‚ã«å¿…é ˆã®Intents ã‚’æŒ‡å®š â˜…
const client = new Client({
  intents: [
    GatewayIntentBits.Guilds,
    GatewayIntentBits.GuildMessages,
    GatewayIntentBits.MessageContent
  ]
});

// =========================
// Bot èµ·å‹•æ™‚
// =========================
client.once("ready", () => {
  console.log(`âœ… Bot logged in as ${client.user.tag}`);
  client.user.setActivity("TRPG Dice", { type: "PLAYING" });
});

// =========================
// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡å‡¦ç†
// =========================
client.on("messageCreate", message => {
  if (message.author.bot) return;

  const content = message.content.trim();

  // -------------------------
  // ğŸ² ãƒ€ã‚¤ã‚¹ï¼ˆ1d6 / 2d10+3 ç­‰ï¼‰
  // -------------------------
  if (/^\d+d\d+/i.test(content)) {
    const result = rollDiceExpression(content);
    message.channel.send(`ğŸ² ${content} â†’ ${result}`);
    return;
  }

  // -------------------------
  // ğŸ—¡ ãƒ€ãƒ¡ãƒ¼ã‚¸è¡¨
  // -------------------------
  if (content.startsWith("ãƒ€ãƒ¡ãƒ¼ã‚¸")) {
    const weapon = content.replace(/^ãƒ€ãƒ¡ãƒ¼ã‚¸\s*/,"");
    const damageTable = {
      "ç´ æ‰‹":"1D6-2","ãƒ‘ãƒ³ãƒ":"1D6-2","ã‚­ãƒƒã‚¯":"1D6-2","é ­çªã":"1D6-2",
      "ä½“å½“ãŸã‚Š":"1D6-2","æŠ•ã’":"1D6-2","å¼•ãå€’ã—":"1D6-2",
      "çµã‚":"1D6","é¦–çµã‚":"1D6",
      "ãƒŠãƒƒã‚¯ãƒ«":"1D6","ã‚¹ãƒ‘ã‚¤ã‚¯é´":"1D6",
      "ãƒã‚±ãƒƒãƒˆãƒŠã‚¤ãƒ•":"1D6-2","å°å‹ãƒŠã‚¤ãƒ•":"1D6-2","ãƒ¡ã‚¹":"1D6-2",
      "ãƒŠã‚¤ãƒ•":"1D6","è»ç”¨ãƒŠã‚¤ãƒ•":"2D6-2","åŒ…ä¸":"2D6-2",
      "æœ¨åˆ€":"1D6","ãƒ•ãƒ«ãƒ¼ãƒ¬":"2D6-2","æ¨¡é€ åˆ€":"2D6-2","ä»•è¾¼ã¿æ–":"2D6-2",
      "ã‚µãƒ¼ãƒ™ãƒ«":"2D6","å°å¤ªåˆ€":"2D6","æ—¥æœ¬åˆ€":"3D6-2","è„‡å·®":"3D6-2",
      "å¤§å¤ªåˆ€":"3D6","å¤åˆ€":"3D6","é•·è„‡å·®":"3D6",
      "è‰åˆˆã‚ŠéŒ":"1D6+2","å±±åˆ€":"1D6+2","ãƒŠã‚¿":"1D6+2",
      "æ‰‹æ–§":"2D6","å¤§ãƒŠã‚¿":"2D6","æœ¨ã“ã‚Šæ–§":"3D6",
      "æ–":"1D6-2","ã‚¹ãƒ†ãƒƒã‚­":"1D6-2","è­¦æ£’":"1D6",
      "ãƒ–ãƒ©ãƒƒã‚¯ã‚¸ãƒ£ãƒƒã‚¯":"1D6+2","æ£æ£’":"1D6+2","é‡‘æ§Œ":"1D6+2",
      "é‰„æ–":"1D6+2","ãƒãƒ¼ãƒ«":"2D6-2","å¤§å‹ãƒãƒ³ãƒãƒ¼":"2D6-2",
      "é‡‘å±è­¦æ£’":"2D6-2","ã¤ã‚‹ã¯ã—":"2D6+2","ç ´å£Šæ§Œ":"2D6+2",
      "çŸ­æ§":"2D6-2","éŠ›":"2D6-2","éŠƒå‰£":"2D6",
      "é•·æ§":"3D6-2","è–™åˆ€":"3D6-2","ä¸‰åˆæ§":"3D6-2",
      "ãƒã‚µãƒŸ":"1D6-2","ãƒ•ã‚©ãƒ¼ã‚¯":"1D6-2","ã‚¢ã‚¤ã‚¹ãƒ”ãƒƒã‚¯":"1D6-2",
      "é™¶å™¨":"1D6-2","ã‚¬ãƒ©ã‚¹è£½å“":"1D6-2","ç“¶":"1D6-2",
      "çŸ³":"1D6","ãƒ¬ãƒ³ã‚¬":"1D6","æ¤æœ¨é‰¢":"1D6",
      "ãƒ•ãƒ©ã‚¤ãƒ‘ãƒ³":"1D6","ã‚¢ã‚¤ãƒ­ãƒ³":"1D6",
      "ãƒ¢ãƒƒãƒ—":"1D6","æ¤…å­":"1D6","æœº":"1D6","çœ‹æ¿":"1D6",
      "é‰„ãƒ‘ã‚¤ãƒ—":"2D6-2",
      "æŠ•çŸ³":"1D6","å’Œå¼“":"3D6-2","ãƒœã‚¦ã‚¬ãƒ³":"3D6",
      "å°å£å¾„æ‹³éŠƒ":"2D6","ä¸­å£å¾„æ‹³éŠƒ":"3D6",
      "å¤§å£å¾„æ‹³éŠƒ":"3D6+2"
    };

    if (damageTable[weapon]) {
      message.channel.send(`ğŸ—¡ ${weapon} / ${damageTable[weapon]}`);
    } else {
      message.channel.send("â“ ãã®æ­¦å™¨ã¯ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“");
    }
    return;
  }

  // -------------------------
  // ğŸ§  çŸ­æœŸç‹‚æ°—è¡¨
  // -------------------------
  if (["ä¸€æ™‚çš„ç‹‚æ°—","çŸ­æœŸçš„ç‹‚æ°—","çŸ­æœŸç‹‚æ°—"].includes(content)) {
    const table = [
      "æ°—çµ¶ã‚ã‚‹ã„ã¯é‡‘åˆ‡ã‚Šå£°",
      "ãƒ‘ãƒ‹ãƒƒã‚¯çŠ¶æ…‹ã§é€ƒèµ°",
      "æ„Ÿæƒ…ã®å™´å‡ºï¼ˆå¤§ç¬‘ã„ãƒ»å¤§æ³£ãï¼‰",
      "æ„å‘³ä¸æ˜ãªå¤šå¼ç—‡",
      "æ¥µåº¦ã®ææ€–ç—‡",
      "æ®ºäººç™–ï¼è‡ªæ®ºç™–",
      "å¹»è¦šãƒ»å¦„æƒ³",
      "åéŸ¿å‹•ä½œãƒ»åéŸ¿è¨€èª",
      "ç•°æ§˜ãªç‰©ã‚’é£Ÿã¹ãŸãŒã‚‹",
      "æ˜è¿·ï¼ç·Šå¼µç—‡"
    ];
    const roll = rollDice(1,10);
    message.channel.send(`ğŸ§  çŸ­æœŸçš„ç‹‚æ°— (${roll})ï¼š${table[roll-1]}`);
    return;
  }

  // -------------------------
  // ğŸ§  é•·æœŸç‹‚æ°—è¡¨
  // -------------------------
  if (["é•·æœŸçš„ç‹‚æ°—","é•·æœŸç‹‚æ°—","ä¸å®šã®ç‹‚æ°—","ä¸å®šç‹‚æ°—"].includes(content)) {
    const table = [
      "å¥å¿˜ç—‡ï¼æ˜è¿·",
      "æ¿€ã—ã„ææ€–ç—‡",
      "å¹»è¦š",
      "å¥‡å¦™ãªæ€§çš„å—œå¥½",
      "ãƒ•ã‚§ãƒ†ã‚£ãƒƒã‚·ãƒ¥",
      "åˆ¶å¾¡ä¸èƒ½ã®ãƒãƒƒã‚¯",
      "å¿ƒå› æ€§éšœå®³",
      "çŸ­æ™‚é–“ã®å¿ƒå› åå¿œ",
      "ååŸ·ç—‡",
      "å¼·è¿«è¦³å¿µè¡Œå‹•"
    ];
    const roll = rollDice(1,10);
    message.channel.send(`ğŸ§  é•·æœŸçš„ç‹‚æ°— (${roll})ï¼š${table[roll-1]}`);
    return;
  }
});

// =========================
// ğŸ² ãƒ€ã‚¤ã‚¹é–¢æ•°
// =========================
function rollDice(count, sides) {
  let total = 0;
  for (let i=0;i<count;i++) total += Math.floor(Math.random()*sides)+1;
  return total;
}

function rollDiceExpression(expr) {
  let total = 0;
  const parts = expr.match(/[+-]?[^+-]+/g);
  for (const p of parts) {
    if (p.includes("d")) {
      const [c,s] = p.replace("+","").split("d").map(Number);
      total += rollDice(c,s);
    } else {
      total += Number(p);
    }
  }
  return total;
}

// =========================
// ğŸ”‘ Bot ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã“ã“ã«ä»£å…¥
// =========================
client.login("â˜…ã“ã“ã«Botãƒˆãƒ¼ã‚¯ãƒ³â˜…");
